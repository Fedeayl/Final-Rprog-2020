---
title: "Trabajo final"
author: "Federico Acosta y Lara"
date: "12/17/2020"
output: pdf_document
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```


```{r}
Data <- rio::import(here::here("Data","elecciones_nacionales_19_hoja_circuito.xlsx"))
Edades <- rio::import(here::here("Data","edad_circuitos_promedio_2019.xlsx"))

library(kableExtra)
library(ggplot2)
library(ggthemes)
source(here::here("Funciones.R"))

Base <- Data
```



1. ¿Cuál fue el resultado de la elección en porcentaje a nivel nacional?

```{r}
T1 <- doBy::summary_by(data = FUN_Votos(Base), formula = CNT_VOTOS ~ LEMA, 
                               FUN = sum, order = FALSE)
T1$Porcentaje <- round(100*(T1$CNT_VOTOS /sum(T1$CNT_VOTOS)),2)

kbl(T1, caption = "Resultado por departamento. Elección nacional. Uruguay 2019" , 
    col.names = c("Partido", "Votos", "% del total") )%>% 
  kable_paper("hover", full_width = F, html_font = "Cambria" ) %>% 
  kable_styling(font_size = 12) %>% 
  footnote("Fuente: Elaboración propia en base a datos de la Corte Electoral", 
           general_title = "", fixed_small_size = T)


```

2. ¿Quién ganó la elección en cada departamento y cuál fue la distancia en términos porcentuales entre el primero y el segundo en cada departamento

```{r}

T2 <- winner(Base)

T2 %>% 
  kbl(caption = "Partido ganador por departamento y margen de victoria. Elección Nacional. Uruguay 2019",
      col.names = c("Departamento", "Partido Ganador", "Margen (%)"),align = "llr") %>% 
  kable_paper("hover", full_width = F, html_font = "Cambria" ) %>% 
  kable_styling(font_size = 12) %>% 
  footnote("Fuente: Elaboración propia en base a datos de la Corte Electoral", 
           general_title = "", fixed_small_size = T)

```


3. ¿Cuál fue la hoja de votación más votada en cada departamento y para cada uno de los tres partidos principales del sistema?

```{r}

T3 <- Hoja_win(Base)

T3 %>% 
  kbl(caption = "Hoja más votada por departamento y por partido. Elección nacional. Uruguay 2019") %>% 
  kable_paper("hover", full_width = F, html_font = "Cambria" ) %>% 
  kable_styling(font_size = 12) %>% 
  collapse_rows(columns = 1) %>% 
  footnote("Fuente: Elaboración propia en base a datos de la Corte Electoral", 
           general_title = "", fixed_small_size = T)



Hx <- unique(T3$Hoja)
H <- function(Tabla, Vector) { 
  v <- vector()
  for(i in 1:length(Vector)){
     v[i]  <- sum(Vector[i]==Tabla$Hoja)
  }
  v
}
H(T3, Hx)

```


4. ¿En que departamento votó mejor el partido Cabildo Abierto?

```{r}

Base <- Data

TotalDepto <- aggregate(CNT_VOTOS ~ DEPTO, data = Base, sum)
ResCA<- aggregate(CNT_VOTOS ~ DEPTO, data = Base, sum, subset = Base$LEMA =="Partido Cabildo Abierto")
ResCA$porcentaje <- round(100*(ResCA$CNT_VOTOS/TotalDepto$CNT_VOTOS),2)

ResCA$DEPTO[which.max(ResCA$porcentaje)]

```
              

5. ¿Cuál es la distribución de edad en los circuitos de todo el país en donde ganó o salió segundo Cabildo Abierto?

```{r}
Base <- Data

Edad <- Edades[c(1,2,6)]
names(Edad) <- c("DEPTO", "CIRCUITO", "Edadprom")
Cabildo <- rbind(Primero = Circ_winner(Base, Partido = "Partido Cabildo Abierto"),
                 Segundo = Circ_second(Base, Partido = "Partido Cabildo Abierto"))

CabildoA <- merge(Edad, Cabildo, by=c("DEPTO", "CIRCUITO"))


Estadisticos(CabildoA$Edadprom)


par(mfrow=c(1,1))
boxplot(CabildoA$Edadprom, col = "gold1",
        main = "Distribución de edad promedio",
        sub= "Circuitos donde CA fue exitoso",
        ylim = c(18,90),
        ylab= "años")


```

6. Presente los resultados de la pregunta 1 y 2 gráficamente

```{r}

T1 <- doBy::summary_by(data = FUN_Votos(Base), formula = CNT_VOTOS ~ LEMA, 
                               FUN = sum, order = FALSE)
T1$Porcentaje <- round(100*(T1$CNT_VOTOS /sum(T1$CNT_VOTOS)),2)

T1x <- reshape2::melt(T1)
T1x <- T1x[T1x$variable == "Porcentaje",]
T1x$LEMA <-  c("FA", "PN","PC", "CA", "PERI", "PG", "PI", "PVA", "AP", "PD", "PT")

G1 <- ggplot(data = T1x, aes(x = reorder(LEMA, -value), y = value)) +
geom_bar(stat="identity", position="stack", fill = "deepskyblue4", color = "black") + ylim(0,50) +
geom_text(aes(label= paste0(value, "%")), vjust = -0.5, color = "gray9", size = 3) + labs(x = "", y = "",
title = "Resultado de la elección nacional", subtitle = "27 de octubre de 2019",
caption = "Elaboración en base a datos de la Corte Electoral") +
theme_calc()

G1
```


7. Presente gráficamente (en un panel) un ajuste lineal de la votación por circuito de cada partido y la edad promedio de cada circuito de Montevideo

```{r}

Edad <- Edades[c(1,2,6)]
names(Edad) <- c("DEPTO", "CIRCUITO", "Edadprom")

DF <- FUN_Votos(Base, Departamento = "Montevideo", Circuito = TRUE)
DF <- merge(DF, Edad, by=c("DEPTO", "CIRCUITO"))


G2 <- ggplot(DF, aes(x=CNT_VOTOS, y=Edadprom))+
  geom_point()+
  facet_wrap(~reorder(LEMA, -CNT_VOTOS), scales = "free") +
  geom_smooth(method='lm')+
  labs(colour = NULL, title = "Votación por partido y por circuito vs edad promedio del circuito",
             subtitle = "Elecciones nacionales. Uruguay 2019",
             caption = "Fuente: elaboración propia sobre datos de la Corte Electoral")+
  xlab("Cantidad de votos")+
  ylab("Edad promedio del circuito")+
  theme(plot.margin = margin(30,30,30,30))+
  theme_calc()

G2


```


